<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Shree Mangalam Jewellers â€“ Quick Quotation</title>
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        :root { 
            --maroon: #7a2222; 
            --maroon-dark: #4d1313; 
            --gold: #d9b25f; 
            --bg: #f7f3ee; 
            --text: #5f5146; 
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-user-select: none;
            user-select: none;
        }

        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        body { 
            margin: 0; 
            min-height: 100vh; 
            font-family: "Poppins", sans-serif; 
            background: radial-gradient(circle at top, #fbe9d7, #f3ebe4 35%, #e6ded6 100%); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
            color: var(--text); 
            touch-action: manipulation; 
        }

        .shell { max-width: 580px; width: 100%; }

        .card { 
            background: #ffffff; 
            border-radius: 24px; 
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12); 
            padding: 28px 24px; 
            position: relative; 
            overflow: hidden; 
        }

        .brand-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .brand-logo { width: 68px; height: 68px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15)); }
        .brand-name { font-family: "Playfair Display", serif; font-size: 1.5rem; color: var(--maroon-dark); line-height: 1.2; }
        .brand-subtitle { font-size: 0.75rem; text-transform: uppercase; color: #8a7b6e; letter-spacing: 0.05em; }

        .divider { 
            height: 1px; 
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.08), transparent); 
            margin: 12px 0 18px; 
        }

        .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h2 { margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.18em; color: #a19388; font-weight: 600; }

        .btn-small { 
            font-size: 0.7rem; 
            padding: 5px 12px; 
            border-radius: 999px; 
            border: 1px solid #e1d6c8; 
            cursor: pointer; 
            background: #fdfaf7; 
            color: #8a7b6e; 
            transition: 0.2s; 
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1.5px solid #eee5db;
            margin-bottom: 8px;
            display: none;
            background: #000;
        }

        /* Focus UI Styling */
        #focus-container {
            display: none;
            background: #fdfaf7;
            padding: 15px;
            border-radius: 12px;
            border: 1.5px solid #eee5db;
            margin-bottom: 12px;
        }

        label { display: block; font-size: 0.8rem; margin-bottom: 6px; color: #8a7b6e; font-weight: 500; }

        textarea, input[type="number"] { 
            width: 100%; 
            border-radius: 12px; 
            border: 1.5px solid #eee5db; 
            padding: 10px 14px; 
            font-size: 0.9rem; 
            font-family: "Poppins", monospace; 
            background: #fbf9f7; 
            outline: none; 
            transition: border-color 0.3s; 
        }

        .result-panel { 
            margin-top: 10px; 
            border-radius: 20px; 
            padding: 20px; 
            background: linear-gradient(135deg, #fffcf5, #f8f1e5); 
            border: 1px solid rgba(217,178,95,0.4); 
            display: none; 
        }

        .result-mrp { font-family: "Playfair Display", serif; font-size: 2.2rem; color: var(--maroon-dark); font-weight: 700; }

        .actions-row { display: flex; gap: 8px; margin-top: 14px; }

        .btn-pill { 
            flex: 1; 
            font-size: 0.8rem; 
            padding: 12px 0; 
            border-radius: 999px; 
            border: none; 
            cursor: pointer; 
            text-transform: uppercase; 
            font-weight: 600; 
        }

        .btn-primary { background: linear-gradient(135deg, var(--maroon), var(--maroon-dark)); color: #fff; flex: 2; }
        .btn-outline { background: #fff; border: 1.5px solid #eee5db; color: #8a7b6e; }

        .btn-grey { 
            background: #f0ece7 !important; 
            border: 1.5px solid #e1d6c8 !important; 
            color: #73685d !important; 
        }

        .history { 
            margin-top: 20px; 
            border-radius: 20px; 
            border: 1.5px solid #eee5db; 
            background: #fdfbf9; 
            padding: 16px; 
            display: none; 
        }

        .history-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
        .history-table th, .history-table td { padding: 12px 6px; text-align: right; border-bottom: 1px solid #f0e9e1; }
        .history-table th:nth-child(2), .history-table td:nth-child(2), .history-table th:nth-child(3), .history-table td:nth-child(3) { text-align: left; }
        .history-table th { color: #b5a89d; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.05em; }

        .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #e1d6c8; transition: 0.3s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: 0.3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--maroon); }
        input:checked + .slider:before { transform: translateX(14px); }

        .numpad { 
            position: fixed; 
            bottom: 0; left: 0; right: 0; 
            background: #fff; 
            z-index: 1000; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1); 
            border-top-left-radius: 24px; 
            border-top-right-radius: 24px; 
            padding: 15px; 
            transform: translateY(100%); 
            transition: transform 0.3s ease; 
            display: none; 
        }

        .is-mobile .numpad { display: block; }
        .numpad.active { transform: translateY(0); }

        .numpad-preview { 
            background: #fdfaf7; 
            padding: 10px; 
            border-radius: 12px; 
            text-align: center; 
            margin-bottom: 10px; 
            border: 1px solid #eee5db; 
            font-weight: 600; 
            color: var(--maroon); 
            font-size: 1.2rem; 
        }

        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .numpad-grid button { 
            background: #fdfaf7; 
            border: 1px solid #eee5db; 
            padding: 15px; 
            font-size: 1.3rem; 
            border-radius: 12px; 
            color: var(--maroon-dark); 
            font-weight: 600; 
            cursor: pointer; 
        }
        .numpad-grid .done-btn { background: var(--maroon) !important; color: #fff !important; grid-column: span 3; font-size: 1rem !important; margin-top: 5px; }
    </style>
</head>

<body>
    <div class="shell">
        <div class="card">
            <div class="brand-header">
                <img src="logo.png" alt="Logo" class="brand-logo" />
                <div class="brand-text">
                    <div class="brand-name">Shree Mangalam Jewellers</div>
                    <div class="brand-subtitle">Specialist in Silver 925 â€¢ Since 1994</div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="title-row">
                <h2>Quick Quotation</h2>
                <div style="display:flex; gap: 8px;">
                    <button class="btn-small" id="scan-camera-btn">ðŸ“· Scan</button>
                    <button class="btn-small" id="sample-btn">Sample</button>
                </div>
            </div>

            <div id="reader"></div>

            <div id="focus-container">
                <label style="display:flex; justify-content:space-between;">
                    Manual Focus <span id="focus-val">Auto</span>
                </label>
                <input type="range" id="focus-slider" min="0" max="100" step="1" style="width:100%; accent-color:var(--maroon); cursor:pointer;">
            </div>

            <div style="margin-bottom: 12px;">
                <label>Scan QR</label>
                <textarea id="qr-text" rows="2" placeholder="Scan results appear here..."></textarea>
            </div>

            <div style="margin-bottom: 8px;">
                <label>Silver rate per gram (â‚¹)</label>
                <input id="silver-rate" type="number" step="0.01" value="225" />
            </div>

            <div id="duplicate-error" style="display:none; color:var(--maroon); font-size:0.75rem; text-align:center;">âš  Item already in history.</div>

            <div class="result-panel" id="result-panel">
                <div style="font-size:0.65rem; text-transform:uppercase; color:#b0956b; letter-spacing:0.25em;">MRP Estimate</div>
                <div id="result-code" style="font-size:0.85rem; color:#8a7b6e; font-weight:500;"></div>
                <div class="result-mrp">â‚¹<span id="result-mrp-val">0.00</span></div>
                <div class="result-meta" id="result-meta"></div>
            </div>

            <div class="actions-row">
                <button class="btn-pill btn-primary" id="add-btn">Add item</button>
                <button class="btn-pill btn-outline btn-grey" id="clear-btn">Clear</button>
                <button class="btn-pill btn-outline" id="reset-btn">Reset</button>
            </div>

            <div class="history" id="history-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items: baseline;">
                    <span style="font-size:0.7rem; text-transform:uppercase; color:#b5a89d; font-weight:700;">History</span>
                    <span style="font-size:0.9rem; color:var(--maroon-dark);">Total: <b>â‚¹<span id="history-total">0.00</span></b></span>
                </div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code</th>
                            <th>Item</th>
                            <th>Net wt</th>
                            <th>MRP</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="numpad" id="numpad">
        <div class="numpad-preview" id="num-preview">0</div>
        <div class="numpad-grid">
            <button onclick="numTap('1')">1</button><button onclick="numTap('2')">2</button><button onclick="numTap('3')">3</button>
            <button onclick="numTap('4')">4</button><button onclick="numTap('5')">5</button><button onclick="numTap('6')">6</button>
            <button onclick="numTap('7')">7</button><button onclick="numTap('8')">8</button><button onclick="numTap('9')">9</button>
            <button onclick="numTap('.')">.</button><button onclick="numTap('0')">0</button><button onclick="numDel()">âŒ«</button>
            <button class="done-btn" onclick="closeNumpad()">DONE</button>
        </div>
    </div>

    <script>
        const qrText = document.getElementById("qr-text"), 
              rateEl = document.getElementById("silver-rate"), 
              resPanel = document.getElementById("result-panel"), 
              resBody = document.getElementById("history-body"), 
              histSection = document.getElementById("history-section"), 
              totalEl = document.getElementById("history-total");

        const focusContainer = document.getElementById('focus-container');
        const focusSlider = document.getElementById('focus-slider');
        const focusVal = document.getElementById('focus-val');

        let items = [], current = null, isScannerOn = false;
        const html5QrCode = new Html5Qrcode("reader");

        // Beep Sound
        function playBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}
        }

        // Camera Logic
        document.getElementById("scan-camera-btn").onclick = async () => {
            const readerDiv = document.getElementById("reader");
            if(isScannerOn) {
                await html5QrCode.stop();
                readerDiv.style.display = "none";
                focusContainer.style.display = "none";
                isScannerOn = false;
            } else {
                readerDiv.style.display = "block";
                isScannerOn = true;
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 20, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        playBeep();
                        // Smart Paste: Add newline if box is not empty
                        if (qrText.value.trim()) {
                            qrText.value += "\n" + decodedText + "\n";
                        } else {
                            qrText.value = decodedText + "\n";
                        }
                        qrText.dispatchEvent(new Event('input'));
                        
                        html5QrCode.stop().then(() => {
                            readerDiv.style.display = "none";
                            focusContainer.style.display = "none";
                            isScannerOn = false;
                        });
                    }
                ).then(() => {
                    // Try to enable Focus Control
                    const track = html5QrCode.getRunningTrack();
                    const capabilities = track.getCapabilities();
                    if (capabilities.focusDistance) {
                        focusContainer.style.display = "block";
                        focusSlider.min = capabilities.focusDistance.min;
                        focusSlider.max = capabilities.focusDistance.max;
                        focusSlider.step = capabilities.focusDistance.step;
                        focusSlider.oninput = async (e) => {
                            focusVal.innerText = e.target.value;
                            await track.applyConstraints({
                                advanced: [{ focusMode: "manual", focusDistance: parseFloat(e.target.value) }]
                            });
                        };
                    }
                });
            }
        };

        // Standard App Logic
        qrText.addEventListener("input", function() {
            const lines = this.value.split('\n').filter(l => l.trim());
            if (lines.length > 1) { 
                for (let i = 0; i < lines.length - 1; i++) {
                    let temp = parseLine(lines[i].trim());
                    if (temp && !items.some(it => it.code === temp.code)) items.push(temp);
                }
                this.value = lines[lines.length - 1]; 
                renderHistory(); 
            }
            current = parseLine(this.value.trim()); updatePanel();
        });

        function parseLine(raw) {
            const p = raw.split(","); if (p.length < 6) return null;
            const rate = parseFloat(rateEl.value) || 0, code = p[0].trim(), wt = parseFloat(p[3]), making = parseFloat(p[5]);
            const mrp = wt * (rate + making) * 1.03;
            return { code, wt, making, mrp, rate };
        }

        function updatePanel() {
            if (!current) { resPanel.style.display = "none"; return; }
            resPanel.style.display = "block";
            document.getElementById("result-code").textContent = current.code;
            document.getElementById("result-mrp-val").textContent = current.mrp.toFixed(2);
        }

        function renderHistory() {
            if (!items.length) { histSection.style.display="none"; return; }
            histSection.style.display="block";
            resBody.innerHTML = items.map((it, i) => `<tr><td>${i+1}</td><td>${it.code}</td><td>Silver Item</td><td>${it.wt.toFixed(3)}</td><td>â‚¹${it.mrp.toFixed(2)}</td><td><button onclick="items.splice(${i},1);renderHistory()">âœ•</button></td></tr>`).join("");
            totalEl.textContent = items.reduce((s, it) => s + it.mrp, 0).toFixed(2);
        }

        document.getElementById("add-btn").onclick = () => { 
            if(current) { items.push({...current}); current=null; qrText.value=""; resPanel.style.display="none"; renderHistory(); } 
        };

        document.getElementById("reset-btn").onclick = () => { items=[]; renderHistory(); qrText.value=""; resPanel.style.display="none"; };
    </script>
</body>
</html>
