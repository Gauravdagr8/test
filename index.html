<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Shree Mangalam Jewellers â€“ Quick Quotation</title>
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        :root { 
            --maroon: #7a2222; 
            --maroon-dark: #4d1313; 
            --gold: #d9b25f; 
            --bg: #f7f3ee; 
            --text: #5f5146; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; min-height: 100vh; font-family: "Poppins", sans-serif; 
            background: radial-gradient(circle at top, #fbe9d7, #f3ebe4 35%, #e6ded6 100%); 
            display: flex; justify-content: center; align-items: center; padding: 20px; color: var(--text); 
        }

        .shell { max-width: 580px; width: 100%; }
        .card { background: #fff; border-radius: 24px; box-shadow: 0 20px 45px rgba(0,0,0,0.12); padding: 28px 24px; }

        /* Brand Header */
        .brand-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .brand-logo { width: 68px; height: 68px; object-fit: contain; }
        .brand-name { font-family: "Playfair Display", serif; font-size: 1.5rem; color: var(--maroon-dark); line-height: 1.2; }
        .brand-subtitle { font-size: 0.75rem; text-transform: uppercase; color: #8a7b6e; letter-spacing: 0.05em; }

        /* Scanner UI */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; border: 1.5px solid #eee5db; margin-bottom: 8px; display: none; background: #000; }
        
        .camera-controls {
            display: none; background: #fdfaf7; padding: 12px; border-radius: 12px; border: 1.5px solid #eee5db; margin-bottom: 12px;
        }
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .control-row:last-child { margin-bottom: 0; }
        .control-row label { font-size: 0.75rem; font-weight: 600; width: 60px; color: var(--maroon); }
        input[type="range"] { flex: 1; accent-color: var(--maroon); }

        textarea, input[type="number"] { 
            width: 100%; border-radius: 12px; border: 1.5px solid #eee5db; padding: 10px 14px; 
            font-size: 0.9rem; font-family: "Poppins", monospace; background: #fbf9f7; outline: none; 
        }

        /* Results & Buttons */
        .result-panel { margin-top: 10px; border-radius: 20px; padding: 20px; background: linear-gradient(135deg, #fffcf5, #f8f1e5); border: 1px solid rgba(217,178,95,0.4); display: none; }
        .result-mrp { font-family: "Playfair Display", serif; font-size: 2.2rem; color: var(--maroon-dark); font-weight: 700; }
        .actions-row { display: flex; gap: 8px; margin-top: 14px; }
        .btn-pill { flex: 1; font-size: 0.8rem; padding: 12px 0; border-radius: 999px; border: none; cursor: pointer; text-transform: uppercase; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, var(--maroon), var(--maroon-dark)); color: #fff; }
        .btn-outline { background: #fff; border: 1.5px solid #eee5db; color: #8a7b6e; }

        /* History */
        .history { margin-top: 20px; border-radius: 20px; border: 1.5px solid #eee5db; background: #fdfbf9; padding: 16px; display: none; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
        .history-table th, .history-table td { padding: 10px 5px; text-align: left; border-bottom: 1px solid #f0e9e1; }
    </style>
</head>

<body>
    <div class="shell">
        <div class="card">
            <div class="brand-header">
                <img src="logo.png" alt="Logo" class="brand-logo" />
                <div>
                    <div class="brand-name">Shree Mangalam Jewellers</div>
                    <div class="brand-subtitle">Silver 925 Specialist</div>
                </div>
            </div>

            <div id="reader"></div>

            <div class="camera-controls" id="camera-controls">
                <div class="control-row" id="zoom-row" style="display:none;">
                    <label>Zoom</label>
                    <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1">
                </div>
                <div class="control-row" id="focus-row" style="display:none;">
                    <label>Focus</label>
                    <input type="range" id="focus-slider" min="0" max="100" step="1">
                </div>
            </div>

            <div style="margin-bottom: 12px;">
                <label style="font-size: 0.8rem; color: #8a7b6e;">Scan Results</label>
                <textarea id="qr-text" rows="3" placeholder="Scan items here..."></textarea>
            </div>

            <div style="margin-bottom: 12px;">
                <label style="font-size: 0.8rem; color: #8a7b6e;">Silver Rate (â‚¹)</label>
                <input id="silver-rate" type="number" value="225" />
            </div>

            <div class="result-panel" id="result-panel">
                <div id="result-code" style="font-size:0.8rem; color:#8a7b6e;"></div>
                <div class="result-mrp">â‚¹<span id="result-mrp-val">0.00</span></div>
            </div>

            <div class="actions-row">
                <button class="btn-pill btn-outline" id="scan-camera-btn">ðŸ“· Open Camera</button>
                <button class="btn-pill btn-primary" id="add-btn">Add to List</button>
            </div>

            <div class="history" id="history-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-weight:700; font-size:0.8rem;">HISTORY</span>
                    <span style="color:var(--maroon-dark); font-weight:700;">Total: â‚¹<span id="history-total">0.00</span></span>
                </div>
                <table class="history-table">
                    <tbody id="history-body"></tbody>
                </table>
                <button class="btn-pill btn-outline" style="width:100%; margin-top:10px;" onclick="resetAll()">Reset All</button>
            </div>
        </div>
    </div>

    <script>
        const qrText = document.getElementById("qr-text");
        const rateEl = document.getElementById("silver-rate");
        const resPanel = document.getElementById("result-panel");
        const resBody = document.getElementById("history-body");
        const histSection = document.getElementById("history-section");
        const totalEl = document.getElementById("history-total");
        
        const cameraControls = document.getElementById("camera-controls");
        const zoomRow = document.getElementById("zoom-row");
        const zoomSlider = document.getElementById("zoom-slider");
        const focusRow = document.getElementById("focus-row");
        const focusSlider = document.getElementById("focus-slider");

        let items = [], current = null, isScannerOn = false;
        const html5QrCode = new Html5Qrcode("reader");

        // Camera Activation
        document.getElementById("scan-camera-btn").onclick = async () => {
            if(isScannerOn) {
                await html5QrCode.stop();
                document.getElementById("reader").style.display = "none";
                cameraControls.style.display = "none";
                isScannerOn = false;
            } else {
                document.getElementById("reader").style.display = "block";
                isScannerOn = true;
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 20, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        // SMART PASTE LOGIC
                        if (qrText.value.trim().length > 0) {
                            qrText.value = qrText.value.trim() + "\n" + decodedText + "\n";
                        } else {
                            qrText.value = decodedText + "\n";
                        }
                        qrText.dispatchEvent(new Event('input'));
                    }
                ).then(() => {
                    cameraControls.style.display = "block";
                    const track = html5QrCode.getRunningTrack();
                    const caps = track.getCapabilities();

                    // Enable Zoom if supported (Most Androids)
                    if (caps.zoom) {
                        zoomRow.style.display = "flex";
                        zoomSlider.min = caps.zoom.min;
                        zoomSlider.max = caps.zoom.max;
                        zoomSlider.step = caps.zoom.step;
                        zoomSlider.oninput = () => track.applyConstraints({advanced: [{zoom: zoomSlider.value}]});
                    }

                    // Enable Focus if supported (Rare on Web, but included)
                    if (caps.focusDistance) {
                        focusRow.style.display = "flex";
                        focusSlider.min = caps.focusDistance.min;
                        focusSlider.max = caps.focusDistance.max;
                        focusSlider.oninput = () => track.applyConstraints({advanced: [{focusMode: "manual", focusDistance: focusSlider.value}]});
                    }
                });
            }
        };

        // Calculation Logic
        qrText.addEventListener("input", function() {
            const lines = this.value.split('\n').filter(l => l.trim());
            if (lines.length > 1) {
                for (let i = 0; i < lines.length - 1; i++) {
                    let it = parseLine(lines[i]);
                    if (it) items.push(it);
                }
                this.value = lines[lines.length - 1];
                renderHistory();
            }
            current = parseLine(this.value);
            updatePanel();
        });

        function parseLine(raw) {
            const p = raw.split(","); if (p.length < 6) return null;
            const rate = parseFloat(rateEl.value), wt = parseFloat(p[3]), making = parseFloat(p[5]);
            return { code: p[0], mrp: wt * (rate + making) * 1.03, wt };
        }

        function updatePanel() {
            if (!current) { resPanel.style.display = "none"; return; }
            resPanel.style.display = "block";
            document.getElementById("result-code").innerText = current.code;
            document.getElementById("result-mrp-val").innerText = current.mrp.toFixed(2);
        }

        function renderHistory() {
            if (!items.length) { histSection.style.display = "none"; return; }
            histSection.style.display = "block";
            resBody.innerHTML = items.map((it, i) => `
                <tr>
                    <td>${it.code}</td>
                    <td>${it.wt}g</td>
                    <td style="text-align:right; font-weight:600;">â‚¹${it.mrp.toFixed(2)}</td>
                    <td style="text-align:right;"><button onclick="items.splice(${i},1);renderHistory()" style="background:none; border:none; color:red;">âœ•</button></td>
                </tr>
            `).join("");
            totalEl.innerText = items.reduce((s, it) => s + it.mrp, 0).toFixed(2);
        }

        document.getElementById("add-btn").onclick = () => {
            if (current) { items.push(current); current = null; qrText.value = ""; renderHistory(); updatePanel(); }
        };

        function resetAll() { items = []; renderHistory(); qrText.value = ""; updatePanel(); }
    </script>
</body>
</html>
