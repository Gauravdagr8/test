<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Shree Mangalam Jewellers – Quick Quotation</title>
    <link rel="icon" type="image/png" href="logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root { --maroon: #7a2222; --maroon-dark: #4d1313; --gold: #d9b25f; --bg: #f7f3ee; --text: #5f5146; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }
        body { margin: 0; min-height: 100vh; font-family: "Poppins", sans-serif; background: radial-gradient(circle at top, #fbe9d7, #f3ebe4 35%, #e6ded6 100%); display: flex; justify-content: center; align-items: center; padding: 20px; color: var(--text); touch-action: manipulation; }
        .shell { max-width: 580px; width: 100%; }
        .card { background: #ffffff; border-radius: 24px; box-shadow: 0 20px 45px rgba(0, 0, 0, 0.12); padding: 28px 24px; position: relative; overflow: hidden; }
        .brand-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .brand-logo { width: 68px; height: 68px; object-fit: contain; }
        .brand-name { font-family: "Playfair Display", serif; font-size: 1.5rem; color: var(--maroon-dark); line-height: 1.2; }
        .divider { height: 1px; background: linear-gradient(to right, transparent, rgba(0,0,0,0.08), transparent); margin: 12px 0 18px; }
        .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h2 { margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.18em; color: #a19388; font-weight: 600; }
        
        /* QR Reader Container */
        #reader-container { display: none; margin-bottom: 15px; border-radius: 16px; overflow: hidden; border: 2px solid var(--gold); }
        #reader { width: 100%; background: #000; }

        .input-group { position: relative; margin-bottom: 12px; }
        .scan-btn { position: absolute; right: 8px; top: 32px; background: var(--maroon); color: white; border: none; border-radius: 8px; padding: 8px; cursor: pointer; display: flex; align-items: center; }
        
        textarea, input[type="number"] { width: 100%; border-radius: 12px; border: 1.5px solid #eee5db; padding: 10px 14px; font-size: 0.9rem; font-family: "Poppins", monospace; background: #fbf9f7; outline: none; }
        .result-panel { margin-top: 10px; border-radius: 20px; padding: 20px; background: linear-gradient(135deg, #fffcf5, #f8f1e5); border: 1px solid rgba(217,178,95,0.4); display: none; }
        .result-mrp { font-family: "Playfair Display", serif; font-size: 2.2rem; color: var(--maroon-dark); font-weight: 700; }
        .actions-row { display: flex; gap: 8px; margin-top: 14px; }
        .btn-pill { flex: 1; font-size: 0.8rem; padding: 12px 0; border-radius: 999px; border: none; cursor: pointer; text-transform: uppercase; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, var(--maroon), var(--maroon-dark)); color: #fff; flex: 2; }
        .btn-outline { background: #fff; border: 1.5px solid #eee5db; color: #8a7b6e; }
        .history { margin-top: 20px; border-radius: 20px; border: 1.5px solid #eee5db; background: #fdfbf9; padding: 16px; display: none; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
        .history-table th, .history-table td { padding: 12px 6px; text-align: right; border-bottom: 1px solid #f0e9e1; }
        .mrp-clickable { cursor: pointer; color: var(--maroon-dark); font-weight: 600; border-bottom: 1px dashed #d9b25f; }
        .numpad { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; z-index: 1000; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 15px; transform: translateY(100%); transition: transform 0.3s ease; display: none; }
        .is-mobile .numpad { display: block; }
        .numpad.active { transform: translateY(0); }
        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .numpad-grid button { background: #fdfaf7; border: 1px solid #eee5db; padding: 15px; font-size: 1.3rem; border-radius: 12px; color: var(--maroon-dark); font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #e1d6c8; border-radius: 18px; transition: .3s; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: .3s; }
        input:checked + .slider { background-color: var(--maroon); }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>

<body>
    <div class="shell">
        <div class="card">
            <div class="brand-header">
                <img src="logo.png" alt="Logo" class="brand-logo" />
                <div class="brand-text">
                    <div class="brand-name">Shree Mangalam Jewellers</div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="title-row">
                <h2>Quick Quotation</h2>
                <button class="btn-small" id="sample-btn">Sample</button>
            </div>

            <div id="reader-container">
                <div id="reader"></div>
            </div>

            <div class="input-group">
                <label>Scan QR</label>
                <textarea id="qr-text" rows="2" placeholder="Scan or paste QR..."></textarea>
                <button class="scan-btn" id="start-scan-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="3"/></svg>
                </button>
            </div>

            <div style="margin-bottom: 8px;">
                <label>Silver rate per gram (₹)</label>
                <input id="silver-rate" type="number" step="0.01" value="225" />
            </div>

            <div id="duplicate-error" style="color:var(--maroon); display:none; text-align:center; font-weight:600; background:#fff1f1; padding:6px; border-radius:8px; margin-bottom:10px;">⚠ Item already in history.</div>

            <div class="result-panel" id="result-panel">
                <div id="result-code" style="font-size:0.85rem; color:#8a7b6e; font-weight:500;"></div>
                <div class="result-mrp">₹<span id="result-mrp-val">0.00</span></div>
                <div id="result-meta"></div>
            </div>

            <div class="actions-row">
                <button class="btn-pill btn-primary" id="add-btn">Add item</button>
                <button class="btn-pill btn-outline" id="reset-btn">Reset</button>
            </div>

            <div class="history" id="history-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <span style="font-size:0.7rem; font-weight:700; color:#b5a89d;">HISTORY</span>
                    <span style="font-size:0.9rem; color:var(--maroon-dark);">Total: <b>₹<span id="history-total">0.00</span></b></span>
                </div>
                <table class="history-table">
                    <thead><tr><th>#</th><th style="text-align:left">Code</th><th style="text-align:left">Item</th><th>Wt</th><th>MRP</th><th></th><th></th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="numpad" id="numpad">
        <div id="num-preview" style="text-align:center; font-size:1.5rem; margin-bottom:10px; color:var(--maroon); font-weight:bold;">0</div>
        <div class="numpad-grid">
            <button onclick="numTap('1')">1</button><button onclick="numTap('2')">2</button><button onclick="numTap('3')">3</button>
            <button onclick="numTap('4')">4</button><button onclick="numTap('5')">5</button><button onclick="numTap('6')">6</button>
            <button onclick="numTap('7')">7</button><button onclick="numTap('8')">8</button><button onclick="numTap('9')">9</button>
            <button onclick="numTap('.')">.</button><button onclick="numTap('0')">0</button><button onclick="numDel()">⌫</button>
            <button style="grid-column: span 3; background: var(--maroon); color:white;" onclick="closeNumpad()">DONE</button>
        </div>
    </div>

    <script>
        const qrText = document.getElementById("qr-text"), 
              rateEl = document.getElementById("silver-rate"), 
              resPanel = document.getElementById("result-panel"),
              resBody = document.getElementById("history-body"),
              histSection = document.getElementById("history-section"),
              totalEl = document.getElementById("history-total"),
              numpad = document.getElementById("numpad"),
              preview = document.getElementById("num-preview"),
              readerContainer = document.getElementById("reader-container");

        let items = [], current = null, html5QrCode = null, activeInput = null;
        const itemNames = {"SAS":"Agarbati Stand","SAL":"Amoliya","SAM":"Animal Murti","SAT":"Antiques","SBM":"Baby Braclet","SKB":"Baby Kada","SBJ":"Baby Leg Kada","SBB":"Baju Band","SBG":"Bangles","SBN":"Banta","SBL":"Bell","SBX":"Box","SBK":"Bucket","SCS":"Chain Pandant Set","SCH":"Chains","SCA":"Challa","SCT":"Chatar","SCG":"Chirag","SCL":"Chotla","SCB":"Coins & Bars","SCR":"Couple Rings","SCC":"Couple Set","SCU":"Cup","SDY":"Diya","SER":"Earings","SFC":"Face/Mukota","SCP":"Fancy Pandant","SFW":"Ferwa","SFL":"Flower","SFP":"Foolpatra","SGN":"Ganpati","SGB":"Gents Bracelet","SGR":"Gents Ring","SGH":"Ghar","SGL":"Glass","SGP":"God Pandant","SBT":"Gugra","SGD":"Gulabdani","SHP":"Hath Pan","SID":"Itardani","SJO":"Jodva","SJL":"Jula","SKA":"KADA","SKK":"Kamar Kandora","SKP":"Kapoor Aarti","SKR":"Karanda","SKY":"KEY CHAIN","SKI":"Kohiri/Keri","SLB":"Ladies Bracelet","SLR":"Ladies Ring","SLT":"Lanturn","SLK":"Leg Kada","SLO":"Lota","SLW":"Loti+Wati","SMP":"Mangalsutra Pandant","SMS":"Mangalsutra Set","SMN":"Mani","SPJ":"Mix Pooja","SMT":"Moti Ring","SMK":"Mukut","SMR":"Murti","SNY":"NARYAL","SNK":"Necklace","SPH":"PATH","SPI":"PATRA & YANTRA","SPL":"Payal","SPK":"PICHKARI","SSP":"PIN/BROUCH","SPB":"PLAIN BANDS","SPR":"PURSE","SRD":"Rudhraksh & More","SSH":"Shihasan","SNS":"Shivling+Nag","SSY":"SHREE YANTRA","SSM":"SOLID MURTI","SSF":"Spoon/Fali","STB":"TABIZ","STT":"TATTALU","STE":"Test","STL":"THALI","STG":"Toe Rings","STI":"Trishul","STU":"TULSI","STR":"TURTLE RING","SVG":"Vegetable","SWC":"Waist Chain","SWL":"Watch Charms","SWS":"Watches","SWT":"Wati"};

        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || (navigator.maxTouchPoints > 0);
        if (isMobile) { document.body.classList.add('is-mobile'); rateEl.readOnly = true; rateEl.onclick = () => openNumpad(rateEl); }

        function openNumpad(input) { activeInput = input; preview.innerText = input.value || "0"; numpad.classList.add('active'); }
        window.closeNumpad = () => { numpad.classList.remove('active'); updateAllItems(); };
        window.numTap = (n) => { preview.innerText = (preview.innerText === "0" && n !== '.') ? n : preview.innerText + n; activeInput.value = preview.innerText; };
        window.numDel = () => { preview.innerText = preview.innerText.slice(0, -1) || "0"; activeInput.value = preview.innerText; };

        // CAMERA LOGIC
        document.getElementById("start-scan-btn").onclick = () => {
            readerContainer.style.display = "block";
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    qrText.value = decodedText;
                    stopScanner();
                    processQR();
                },
                (err) => {}
            ).catch(err => alert("Camera error: " + err));
        };

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    readerContainer.style.display = "none";
                }).catch(err => console.error(err));
            }
        }

        function processQR() {
            const val = qrText.value.trim();
            if(!val) return;
            current = parseLine(val);
            updatePanel();
        }

        qrText.oninput = processQR;

        function parseLine(raw) {
            const p = raw.split(","); if (p.length < 6) return null;
            return calculateItem(p[0].trim(), parseFloat(p[3]), parseFloat(rateEl.value), parseFloat(p[5]));
        }

        function calculateItem(code, wt, rate, making, show = true) {
            const mrp = wt * (rate + making) * 1.03;
            return { code, name: itemNames[code.slice(0,3).toUpperCase()] || "Silver", wt, making, mrp, show };
        }

        function updateAllItems() {
            const newRate = parseFloat(rateEl.value) || 0;
            localStorage.setItem("silverRate", newRate);
            if(current) { current = calculateItem(current.code, current.wt, newRate, current.making, current.show); updatePanel(); }
            items = items.map(it => calculateItem(it.code, it.wt, newRate, it.making, it.show));
            renderHistory();
        }

        function updatePanel() {
            if (!current) { resPanel.style.display = "none"; return; }
            resPanel.style.display = "block";
            document.getElementById("result-code").textContent = `${current.code} • ${current.name}`;
            document.getElementById("result-mrp-val").textContent = current.mrp.toFixed(2);
        }

        function renderHistory() {
            if (!items.length) { histSection.style.display="none"; return; }
            histSection.style.display="block";
            resBody.innerHTML = items.map((it, i) => `<tr><td>${i+1}</td><td style="text-align:left">${it.code}</td><td style="text-align:left">${it.name}</td><td>${it.wt.toFixed(3)}</td><td class="mrp-clickable">₹${it.mrp.toFixed(2)}</td><td><button onclick="deleteItem(${i})">×</button></td></tr>`).join("");
            totalEl.textContent = items.reduce((s, it) => s + it.mrp, 0).toFixed(2);
        }

        document.getElementById("add-btn").onclick = () => { 
            if(current){ items.push({...current}); current=null; qrText.value=""; resPanel.style.display="none"; renderHistory(); } 
        };

        window.deleteItem = (i) => { items.splice(i, 1); renderHistory(); };
        document.getElementById("reset-btn").onclick = () => { items=[]; current=null; qrText.value=""; resPanel.style.display="none"; renderHistory(); };
        
        window.onload = () => { rateEl.value = localStorage.getItem("silverRate") || 225; };
    </script>
</body>
</html>